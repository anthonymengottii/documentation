---
title: "Webhooks"
description: "Configure webhooks para receber notifica√ß√µes em tempo real sobre eventos importantes"
---

## Vis√£o geral

**Webhooks** s√£o notifica√ß√µes HTTP enviadas pela Upay Gateway API para sua aplica√ß√£o quando eventos importantes ocorrem. Isso permite que voc√™ reaja em tempo real a mudan√ßas de status, pagamentos confirmados e outros eventos sem precisar fazer polling constante.

## Pr√©-requisitos

Antes de come√ßar, voc√™ precisa:
- Uma conta ativa na Upay
- Sua API Key configurada (veja [Autentica√ß√£o](/pages/authentication))
- Um endpoint HTTPS p√∫blico para receber webhooks

## Funcionalidades

- **Eventos em tempo real**: Receba notifica√ß√µes instant√¢neas
- **M√∫ltiplos eventos**: Configure webhooks para diferentes tipos de eventos
- **Retry autom√°tico**: Tentativas autom√°ticas em caso de falha
- **Seguran√ßa**: Assinatura HMAC para validar requisi√ß√µes
- **Hist√≥rico**: Visualize todos os eventos enviados
- **M√∫ltiplas URLs**: Configure diferentes endpoints para diferentes eventos

## Criando uma assinatura de webhook

### Requisi√ß√£o B√°sica

```bash
curl -X POST "https://upay-sistema-api.onrender.com/api/v1/webhooks/subscriptions" \
  -H "Authorization: Bearer SUA_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://meusite.com.br/webhooks/upay",
    "events": ["transaction.completed", "transaction.failed"],
    "description": "Webhook para notifica√ß√µes de transa√ß√£o"
  }'
```

### Resposta

```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "url": "https://meusite.com.br/webhooks/upay",
    "events": ["payment.completed", "payment.failed"],
    "description": "Webhook para notifica√ß√µes de pagamento",
    "status": "ACTIVE",
    "secret": "whsec_abc123...",
    "createdAt": "2025-12-30T00:00:00.000Z"
  }
}
```

<Warning>
  Guarde o `secret` em local seguro.O Gateway envia webhooks usando o m√©todo **POST** para a URL configurada. Cada envio inclui o cabe√ßalho `X-Webhook-Signature` para valida√ß√£o de integridade.

### Cabe√ßalhos HTTP

| Cabe√ßalho | Descri√ß√£o |
| :--- | :--- |
| `Content-Type` | Sempre `application/json` |
| `X-Webhook-Signature` | Assinatura HMAC-SHA256 (formato: `sha256=ASSINATURA`) |
| `X-Webhook-Event` | Tipo do evento disparado |
| `X-Webhook-Delivery` | ID √∫nico da entrega (UUID) |
| `User-Agent` | `UPAY-Webhook/1.0` |

### Eventos Suportados

| Evento | Descri√ß√£o |
| :--- | :--- |
| `transaction.created` | Uma nova transa√ß√£o foi gerada |
| `transaction.updated` | Uma transa√ß√£o teve seus dados atualizados |
| `transaction.completed` | Pagamento confirmado com sucesso |
| `transaction.failed` | Pagamento falhou ou foi recusado |
| `payment_link.created` | Um link de pagamento foi criado |
| `payment_link.updated` | Um link de pagamento foi editado |
| `balance.updated` | O saldo da conta foi alterado |
</Warning>

### Eventos de Transa√ß√£o (Transaction)

- `transaction.created` - Transa√ß√£o criada
- `transaction.updated` - Status da transa√ß√£o atualizado
- `transaction.completed` - Pagamento confirmado/conclu√≠do
- `transaction.failed` - Pagamento falhou

### Eventos de Link de Pagamento

- `payment_link.created` - Link de pagamento criado
- `payment_link.updated` - Link de pagamento atualizado
- `payment_link.deleted` - Link de pagamento deletado

### Eventos de Produto

- `product.created` - Produto criado
- `product.updated` - Produto atualizado
- `product.deleted` - Produto deletado

### Eventos de Cupom

- `coupon.created` - Cupom criado
- `coupon.used` - Cupom utilizado
- `coupon.expired` - Cupom expirado

## Exemplo completo

```javascript
const response = await fetch('https://upay-sistema-api.onrender.com/api/webhooks/subscriptions', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${apiKey}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    url: 'https://meusite.com.br/webhooks/upay',
    events: [
      'payment.completed',
      'payment.failed',
      'payment.refunded'
    ],
    description: 'Webhook para processar notifica√ß√µes de pagamento'
  })
});

const { data } = await response.json();
console.log('Webhook Secret:', data.secret);
```

## Listando assinaturas

### Listar todas as assinaturas

```bash
curl -X GET "https://upay-sistema-api.onrender.com/api/webhooks/subscriptions" \
  -H "Authorization: Bearer SUA_API_KEY"
```

### Listar eventos enviados

```bash
curl -X GET "https://upay-sistema-api.onrender.com/api/webhooks/events?page=1&limit=20" \
  -H "Authorization: Bearer SUA_API_KEY"
```

## Atualizando uma assinatura

```bash
curl -X PUT "https://upay-sistema-api.onrender.com/api/webhooks/subscriptions/{id}" \
  -H "Authorization: Bearer SUA_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://meusite.com.br/webhooks/upay-v2",
    "events": ["transaction.completed", "transaction.failed"],
    "isActive": true
  }'
```

## Deletando uma assinatura

```bash
curl -X DELETE "https://upay-sistema-api.onrender.com/api/webhooks/subscriptions/{id}" \
  -H "Authorization: Bearer SUA_API_KEY"
```

### Validando a Assinatura

Para garantir que o webhook foi enviado pela UPAY, voc√™ deve validar o header `X-Webhook-Signature`.

1. Obtenha o corpo bruto (raw body) da requisi√ß√£o.
2. Gere um HMAC-SHA256 usando o corpo bruto e o seu `WEBHOOK_SECRET`.
3. Compare o resultado (em hexadecimal) com o valor recebido no header (removendo o prefixo `sha256=`).

Exemplo em Node.js:

```javascript
const crypto = require('crypto');

function verifySignature(payload, signatureHeader, secret) {
  const [algorithm, signature] = signatureHeader.split('=');
  
  if (algorithm !== 'sha256') return false;

  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');

  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```
// No seu endpoint de webhook
app.post('/webhooks/upay', express.json(), (req, res) => {
  const signature = req.headers['x-upay-signature'];
  const secret = process.env.UPAY_WEBHOOK_SECRET;
  
  if (!verifySignature(req.rawBody, signature, secret)) { // req.rawBody √© necess√°rio para a valida√ß√£o
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // Processar webhook
  const event = req.body;
  console.log('Evento recebido:', event.type);
  
  res.status(200).json({ received: true });
});
```

### Exemplo de Valida√ß√£o (Python)

```python
import hmac
import hashlib
import json

def validate_webhook_signature(payload, signature, secret):
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        json.dumps(payload).encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(signature, expected_signature)

# No seu endpoint de webhook
@app.route('/webhooks/upay', methods=['POST'])
def webhook():
    signature = request.headers.get('X-Webhook-Signature', '').replace('sha256=', '')
    secret = os.getenv('UPAY_WEBHOOK_SECRET')
    
    if not validate_webhook_signature(request.json, signature, secret):
        return jsonify({'error': 'Invalid signature'}), 401
    
    # Processar webhook
    event = request.json
    print(f"Evento recebido: {event['type']}")
    
    return jsonify({'received': True}), 200
```

## Estrutura do payload

### Exemplo: transaction.completed

```json
{
  "id": "evt_5f9d7a2b-1234-5678-90ab-cdef12345678",
  "type": "transaction.completed",
  "timestamp": "2024-03-15T10:30:00.000Z",
  "data": {
    "id": "tx_240315_a7b2c9",
    "userId": "usr_987654321",
    "value": 150.00,
    "amountCents": 15000,
    "status": "PAID",
    "paymentMethod": "PIX",
    "paymentDate": "2024-03-15T10:29:55.000Z",
    "completedAt": "2024-03-15T10:30:00.000Z"
  },
  "subscription": {
    "id": "sub_12345678",
    "url": "https://suaapiv1.com/webhooks"
  }
}
```

### Exemplo: payment.failed

```json
{
  "id": "evt_def456",
  "type": "payment.failed",
  "createdAt": "2025-12-30T00:00:00.000Z",
  "data": {
    "transactionId": "550e8400-e29b-41d4-a716-446655440000",
    "paymentLinkId": "550e8400-e29b-41d4-a716-446655440001",
    "amount": 199.00,
    "amountCents": 19900,
    "currency": "BRL",
    "paymentMethod": "credit_card",
    "status": "FAILED",
    "error": "Cart√£o recusado",
    "errorCode": "CARD_DECLINED"
  }
}
```

## üîÑ Retry e Confiabilidade

A UPay tenta entregar webhooks automaticamente:

1. **Primeira tentativa**: Imediata
2. **Retry 1**: Ap√≥s 1 minuto
3. **Retry 2**: Ap√≥s 5 minutos
4. **Retry 3**: Ap√≥s 15 minutos
5. **Retry 4**: Ap√≥s 1 hora

<Note>
  Seu endpoint deve responder com status HTTP 200-299 para confirmar o recebimento. Respostas com erro ou timeout resultar√£o em retry.
</Note>

## Boas pr√°ticas

1. **Responda rapidamente**: Processe webhooks de forma ass√≠ncrona quando poss√≠vel
2. **Valide a assinatura**: Sempre valide o `X-Upay-Signature`
3. **Idempot√™ncia**: Processe eventos de forma idempotente usando o `id` do evento
4. **Logs**: Mantenha logs de todos os webhooks recebidos
5. **Testes**: Use webhooks de teste para validar sua implementa√ß√£o

## Testando webhooks

### Usando ngrok (Desenvolvimento Local)

```bash
# Instale o ngrok
npm install -g ngrok

# Exponha sua aplica√ß√£o local
ngrok http 3000

# Use a URL do ngrok na assinatura do webhook
# Ex: https://abc123.ngrok.io/webhooks/upay
```

### Endpoint de Teste

```javascript
app.post('/webhooks/upay', express.json(), (req, res) => {
  console.log('Webhook recebido:', JSON.stringify(req.body, null, 2));
  res.status(200).json({ received: true });
});
```

## Pr√≥ximos passos

<CardGroup cols={2}>
  <Card title="Refer√™ncia da API" icon="code" href="/api-reference/webhooks">
    Veja todos os endpoints dispon√≠veis
  </Card>
  <Card title="Links de Pagamento" icon="link" href="/pages/guides/features/payment-links">
    Configure webhooks para links de pagamento
  </Card>
</CardGroup>

