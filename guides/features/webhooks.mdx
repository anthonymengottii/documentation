---
title: "Webhooks"
description: "Configure webhooks para receber notifica√ß√µes em tempo real sobre eventos importantes"
---

## üîî Vis√£o Geral

**Webhooks** s√£o notifica√ß√µes HTTP enviadas pela UPay Gateway API para sua aplica√ß√£o quando eventos importantes ocorrem. Isso permite que voc√™ reaja em tempo real a mudan√ßas de status, pagamentos confirmados e outros eventos sem precisar fazer polling constante.

## ‚ú® Funcionalidades

- ‚úÖ **Eventos em Tempo Real**: Receba notifica√ß√µes instant√¢neas
- ‚úÖ **M√∫ltiplos Eventos**: Configure webhooks para diferentes tipos de eventos
- ‚úÖ **Retry Autom√°tico**: Tentativas autom√°ticas em caso de falha
- ‚úÖ **Seguran√ßa**: Assinatura HMAC para validar requisi√ß√µes
- ‚úÖ **Hist√≥rico**: Visualize todos os eventos enviados
- ‚úÖ **M√∫ltiplas URLs**: Configure diferentes endpoints para diferentes eventos

## üöÄ Criando uma Assinatura de Webhook

### Requisi√ß√£o B√°sica

```bash
curl -X POST "https://api.upay-sistema.onrender.com/api/webhooks/subscriptions" \
  -H "Authorization: Bearer SUA_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://meusite.com.br/webhooks/upay",
    "events": ["payment.completed", "payment.failed"],
    "description": "Webhook para notifica√ß√µes de pagamento"
  }'
```

### Resposta

```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "url": "https://meusite.com.br/webhooks/upay",
    "events": ["payment.completed", "payment.failed"],
    "description": "Webhook para notifica√ß√µes de pagamento",
    "status": "ACTIVE",
    "secret": "whsec_abc123...",
    "createdAt": "2025-12-30T00:00:00.000Z"
  }
}
```

<Warning>
  Guarde o `secret` em local seguro. Ele ser√° usado para validar as requisi√ß√µes do webhook.
</Warning>

## üìã Eventos Dispon√≠veis

### Eventos de Pagamento

- `payment.completed` - Pagamento confirmado
- `payment.failed` - Pagamento falhou
- `payment.pending` - Pagamento pendente
- `payment.refunded` - Pagamento reembolsado
- `payment.cancelled` - Pagamento cancelado

### Eventos de Link de Pagamento

- `payment_link.created` - Link de pagamento criado
- `payment_link.updated` - Link de pagamento atualizado
- `payment_link.deleted` - Link de pagamento deletado

### Eventos de Produto

- `product.created` - Produto criado
- `product.updated` - Produto atualizado
- `product.deleted` - Produto deletado

### Eventos de Cupom

- `coupon.created` - Cupom criado
- `coupon.used` - Cupom utilizado
- `coupon.expired` - Cupom expirado

## üìñ Exemplo Completo

```javascript
const response = await fetch('https://api.upay-sistema.onrender.com/api/webhooks/subscriptions', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${apiKey}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    url: 'https://meusite.com.br/webhooks/upay',
    events: [
      'payment.completed',
      'payment.failed',
      'payment.refunded'
    ],
    description: 'Webhook para processar notifica√ß√µes de pagamento'
  })
});

const { data } = await response.json();
console.log('Webhook Secret:', data.secret);
```

## üîç Listando Assinaturas

### Listar Todas as Assinaturas

```bash
curl -X GET "https://api.upay-sistema.onrender.com/api/webhooks/subscriptions" \
  -H "Authorization: Bearer SUA_API_KEY"
```

### Listar Eventos Enviados

```bash
curl -X GET "https://api.upay-sistema.onrender.com/api/webhooks/events?page=1&limit=20" \
  -H "Authorization: Bearer SUA_API_KEY"
```

## ‚úèÔ∏è Atualizando uma Assinatura

```bash
curl -X PUT "https://api.upay-sistema.onrender.com/api/webhooks/subscriptions/{id}" \
  -H "Authorization: Bearer SUA_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://meusite.com.br/webhooks/upay-v2",
    "events": ["payment.completed", "payment.failed", "payment.refunded"],
    "status": "ACTIVE"
  }'
```

## üóëÔ∏è Deletando uma Assinatura

```bash
curl -X DELETE "https://api.upay-sistema.onrender.com/api/webhooks/subscriptions/{id}" \
  -H "Authorization: Bearer SUA_API_KEY"
```

## üîê Validando Webhooks

### Assinatura HMAC

Todas as requisi√ß√µes de webhook incluem um header `X-Upay-Signature` com uma assinatura HMAC-SHA256. Use o `secret` da assinatura para validar que a requisi√ß√£o veio da UPay.

### Exemplo de Valida√ß√£o (Node.js)

```javascript
const crypto = require('crypto');

function validateWebhookSignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(JSON.stringify(payload))
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}

// No seu endpoint de webhook
app.post('/webhooks/upay', express.json(), (req, res) => {
  const signature = req.headers['x-upay-signature'];
  const secret = process.env.UPAY_WEBHOOK_SECRET;
  
  if (!validateWebhookSignature(req.body, signature, secret)) {
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  // Processar webhook
  const event = req.body;
  console.log('Evento recebido:', event.type);
  
  res.status(200).json({ received: true });
});
```

### Exemplo de Valida√ß√£o (Python)

```python
import hmac
import hashlib
import json

def validate_webhook_signature(payload, signature, secret):
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        json.dumps(payload).encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(signature, expected_signature)

# No seu endpoint de webhook
@app.route('/webhooks/upay', methods=['POST'])
def webhook():
    signature = request.headers.get('X-Upay-Signature')
    secret = os.getenv('UPAY_WEBHOOK_SECRET')
    
    if not validate_webhook_signature(request.json, signature, secret):
        return jsonify({'error': 'Invalid signature'}), 401
    
    # Processar webhook
    event = request.json
    print(f"Evento recebido: {event['type']}")
    
    return jsonify({'received': True}), 200
```

## üì® Estrutura do Payload

### Exemplo: payment.completed

```json
{
  "id": "evt_abc123",
  "type": "payment.completed",
  "createdAt": "2025-12-30T00:00:00.000Z",
  "data": {
    "transactionId": "550e8400-e29b-41d4-a716-446655440000",
    "paymentLinkId": "550e8400-e29b-41d4-a716-446655440001",
    "amount": 199.00,
    "amountCents": 19900,
    "currency": "BRL",
    "paymentMethod": "pix",
    "status": "COMPLETED",
    "client": {
      "id": "550e8400-e29b-41d4-a716-446655440002",
      "name": "Jo√£o Silva",
      "email": "joao@example.com"
    }
  }
}
```

### Exemplo: payment.failed

```json
{
  "id": "evt_def456",
  "type": "payment.failed",
  "createdAt": "2025-12-30T00:00:00.000Z",
  "data": {
    "transactionId": "550e8400-e29b-41d4-a716-446655440000",
    "paymentLinkId": "550e8400-e29b-41d4-a716-446655440001",
    "amount": 199.00,
    "amountCents": 19900,
    "currency": "BRL",
    "paymentMethod": "credit_card",
    "status": "FAILED",
    "error": "Cart√£o recusado",
    "errorCode": "CARD_DECLINED"
  }
}
```

## üîÑ Retry e Confiabilidade

A UPay tenta entregar webhooks automaticamente:

1. **Primeira tentativa**: Imediata
2. **Retry 1**: Ap√≥s 1 minuto
3. **Retry 2**: Ap√≥s 5 minutos
4. **Retry 3**: Ap√≥s 15 minutos
5. **Retry 4**: Ap√≥s 1 hora

<Note>
  Seu endpoint deve responder com status HTTP 200-299 para confirmar o recebimento. Respostas com erro ou timeout resultar√£o em retry.
</Note>

## ‚úÖ Boas Pr√°ticas

1. **Responda rapidamente**: Processe webhooks de forma ass√≠ncrona quando poss√≠vel
2. **Valide a assinatura**: Sempre valide o `X-Upay-Signature`
3. **Idempot√™ncia**: Processe eventos de forma idempotente usando o `id` do evento
4. **Logs**: Mantenha logs de todos os webhooks recebidos
5. **Testes**: Use webhooks de teste para validar sua implementa√ß√£o

## üß™ Testando Webhooks

### Usando ngrok (Desenvolvimento Local)

```bash
# Instale o ngrok
npm install -g ngrok

# Exponha sua aplica√ß√£o local
ngrok http 3000

# Use a URL do ngrok na assinatura do webhook
# Ex: https://abc123.ngrok.io/webhooks/upay
```

### Endpoint de Teste

```javascript
app.post('/webhooks/upay', express.json(), (req, res) => {
  console.log('Webhook recebido:', JSON.stringify(req.body, null, 2));
  res.status(200).json({ received: true });
});
```

## üìö Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card title="Refer√™ncia da API" icon="code" href="/api-reference/webhooks">
    Veja todos os endpoints dispon√≠veis
  </Card>
  <Card title="Payment Links" icon="link" href="/guides/features/payment-links">
    Configure webhooks para links de pagamento
  </Card>
</CardGroup>

